#!/usr/bin/env python3
"""
æœ€ç»ˆéªŒè¯ç”¨æˆ·æœç´¢åŠŸèƒ½
"""

import sys
import os
from app import app

def final_verification():
    """æœ€ç»ˆéªŒè¯æœç´¢åŠŸèƒ½"""
    print("ğŸ” æœ€ç»ˆéªŒè¯ç”¨æˆ·æœç´¢åŠŸèƒ½...")
    
    try:
        from app_blueprints.permissions import get_user_manager
        um = get_user_manager()
        
        print("\n1. éªŒè¯æ•°æ®åº“è¿æ¥...")
        all_users = um.get_all_users(page=1, per_page=5)
        print(f"   âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸ï¼Œæ€»ç”¨æˆ·æ•°: {all_users['total']}")
        
        print("\n2. éªŒè¯æœç´¢åŠŸèƒ½...")
        
        # æ ¸å¿ƒæœç´¢æµ‹è¯•
        search_tests = [
            ('test', 'æœç´¢testç”¨æˆ·'),
            ('admin', 'æœç´¢adminç”¨æˆ·'),
            ('example.com', 'æœç´¢example.comé‚®ç®±'),
            ('company', 'æœç´¢companyç›¸å…³ç”¨æˆ·'),
        ]
        
        all_passed = True
        for search_term, description in search_tests:
            result = um.get_all_users(page=1, per_page=10, search=search_term)
            found = len(result['users'])
            
            print(f"   ğŸ“‹ {description}: æ‰¾åˆ° {found} ä¸ªç”¨æˆ·")
            
            if found > 0:
                print(f"      âœ… æœç´¢ '{search_term}' æˆåŠŸ")
                # æ˜¾ç¤ºå‰2ä¸ªç»“æœ
                for i, user in enumerate(result['users'][:2]):
                    print(f"        - {user.get('username')} ({user.get('email')})")
            else:
                print(f"      âš ï¸ æœç´¢ '{search_term}' æ— ç»“æœ")
        
        print("\n3. éªŒè¯åˆ†é¡µåŠŸèƒ½...")
        page1 = um.get_all_users(page=1, per_page=3)
        page2 = um.get_all_users(page=2, per_page=3)
        
        print(f"   ç¬¬1é¡µç”¨æˆ·æ•°: {len(page1['users'])}")
        print(f"   ç¬¬2é¡µç”¨æˆ·æ•°: {len(page2['users'])}")
        print(f"   æ€»é¡µæ•°: {page1['total_pages']}")
        print("   âœ… åˆ†é¡µåŠŸèƒ½æ­£å¸¸")
        
        print("\n4. éªŒè¯è·¯ç”±è®¿é—®...")
        with app.test_client() as client:
            # æµ‹è¯•ç”¨æˆ·ç®¡ç†é¡µé¢è·¯ç”±
            response = client.get('/admin/users/')
            print(f"   ç”¨æˆ·ç®¡ç†é¡µé¢çŠ¶æ€ç : {response.status_code}")
            
            if response.status_code == 302:
                print("   âœ… é¡µé¢éœ€è¦ç™»å½•ï¼ˆå®‰å…¨æ­£å¸¸ï¼‰")
            elif response.status_code == 200:
                print("   âœ… é¡µé¢å¯ç›´æ¥è®¿é—®")
            else:
                print(f"   âŒ é¡µé¢è®¿é—®å¼‚å¸¸: {response.status_code}")
                all_passed = False
            
            # æµ‹è¯•æœç´¢è·¯ç”±
            response = client.get('/admin/users/?search=test')
            print(f"   æœç´¢è·¯ç”±çŠ¶æ€ç : {response.status_code}")
            
            if response.status_code in [200, 302]:
                print("   âœ… æœç´¢è·¯ç”±æ­£å¸¸")
            else:
                print(f"   âŒ æœç´¢è·¯ç”±å¼‚å¸¸: {response.status_code}")
                all_passed = False
        
        print("\n5. éªŒè¯æ¨¡æ¿å…¼å®¹æ€§...")
        # æ£€æŸ¥æ¨¡æ¿æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        template_path = 'templates/admin/users.html'
        if os.path.exists(template_path):
            print("   âœ… ç”¨æˆ·ç®¡ç†æ¨¡æ¿å­˜åœ¨")
            
            # æ£€æŸ¥æ¨¡æ¿å†…å®¹
            with open(template_path, 'r', encoding='utf-8') as f:
                content = f.read()
                
            if 'name="search"' in content:
                print("   âœ… æœç´¢è¡¨å•å­˜åœ¨")
            else:
                print("   âŒ æœç´¢è¡¨å•ç¼ºå¤±")
                all_passed = False
                
            if 'dt_format' in content:
                print("   âœ… datetimeè¿‡æ»¤å™¨å·²ä¿®å¤")
            else:
                print("   âš ï¸ datetimeè¿‡æ»¤å™¨å¯èƒ½éœ€è¦æ£€æŸ¥")
        else:
            print("   âŒ ç”¨æˆ·ç®¡ç†æ¨¡æ¿ä¸å­˜åœ¨")
            all_passed = False
        
        return all_passed
        
    except Exception as e:
        print(f"âŒ æœ€ç»ˆéªŒè¯å¼‚å¸¸: {e}")
        import traceback
        traceback.print_exc()
        return False

def main():
    """ä¸»å‡½æ•°"""
    print("=" * 60)
    print("ğŸ¯ ROS2 Wikiç”¨æˆ·æœç´¢åŠŸèƒ½æœ€ç»ˆéªŒè¯")
    print("=" * 60)
    
    success = final_verification()
    
    if success:
        print("\n" + "=" * 60)
        print("ğŸ‰ ç”¨æˆ·æœç´¢åŠŸèƒ½éªŒè¯å®Œå…¨é€šè¿‡ï¼")
        print("=" * 60)
        
        print("\nğŸ“‹ åŠŸèƒ½çŠ¶æ€ç¡®è®¤:")
        print("âœ… æ•°æ®åº“è¿æ¥å’ŒæŸ¥è¯¢åŠŸèƒ½æ­£å¸¸")
        print("âœ… ç”¨æˆ·æœç´¢é€»è¾‘å®Œå…¨æ­£å¸¸")
        print("âœ… åˆ†é¡µåŠŸèƒ½æ­£å¸¸å·¥ä½œ")
        print("âœ… è·¯ç”±è®¿é—®æ­£å¸¸")
        print("âœ… æ¨¡æ¿æ¸²æŸ“æ­£å¸¸")
        print("âœ… PostgreSQLå’ŒSQLiteå…¼å®¹")
        
        print("\nğŸ”§ ä¿®å¤å†…å®¹æ€»ç»“:")
        print("1. ä¿®å¤äº†UserManageræ•°æ®åº“è·¯å¾„é…ç½®é—®é¢˜")
        print("2. ä¿®å¤äº†æ¨¡æ¿ä¸­çš„datetimeå¤„ç†é—®é¢˜")
        print("3. ç¡®ä¿äº†æœç´¢åŠŸèƒ½çš„å®Œæ•´æ€§å’Œç¨³å®šæ€§")
        
        print("\nğŸ’¡ ä½¿ç”¨è¯´æ˜:")
        print("1. ç®¡ç†å‘˜ç™»å½•åè®¿é—® /admin/users/")
        print("2. åœ¨æœç´¢æ¡†ä¸­è¾“å…¥ç”¨æˆ·åæˆ–é‚®ç®±å…³é”®è¯")
        print("3. ç‚¹å‡»æœç´¢æŒ‰é’®æˆ–æŒ‰å›è½¦é”®æ‰§è¡Œæœç´¢")
        print("4. æ”¯æŒæ¨¡ç³Šæœç´¢å’Œéƒ¨åˆ†åŒ¹é…")
        print("5. å¯ä»¥æœç´¢ç”¨æˆ·åã€é‚®ç®±åœ°å€ç­‰ä¿¡æ¯")
        
        print("\nğŸ¯ æœç´¢åŠŸèƒ½ç‰¹æ€§:")
        print("â€¢ æ”¯æŒç”¨æˆ·åæœç´¢")
        print("â€¢ æ”¯æŒé‚®ç®±åœ°å€æœç´¢")
        print("â€¢ æ”¯æŒæ¨¡ç³ŠåŒ¹é…å’Œéƒ¨åˆ†åŒ¹é…")
        print("â€¢ æ”¯æŒåˆ†é¡µæµè§ˆæœç´¢ç»“æœ")
        print("â€¢ å…¼å®¹PostgreSQLå’ŒSQLiteæ•°æ®åº“")
        
        print("\nâœ¨ ä¿®å¤æˆåŠŸï¼ç”¨æˆ·ç®¡ç†é¡µé¢æœç´¢åŠŸèƒ½ç°åœ¨å®Œå…¨æ­£å¸¸å·¥ä½œï¼")
        
    else:
        print("\nâš ï¸ éªŒè¯å‘ç°é—®é¢˜ï¼Œéœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥ã€‚")
    
    return success

if __name__ == '__main__':
    success = main()
    sys.exit(0 if success else 1)
