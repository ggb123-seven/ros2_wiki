#!/usr/bin/env python3
"""
æ‰‹åŠ¨å®‰è£…Pythonä¾èµ–çš„è„šæœ¬
å½“ç³»ç»Ÿæ²¡æœ‰pipæ—¶ä½¿ç”¨
"""
import sys
import os
import subprocess
import urllib.request
import tempfile
import zipfile

def install_pip():
    """å®‰è£…pip"""
    print("ğŸ“¦ æ­£åœ¨å®‰è£…pip...")
    try:
        # ä¸‹è½½get-pip.py
        url = "https://bootstrap.pypa.io/get-pip.py"
        with urllib.request.urlopen(url) as response:
            with tempfile.NamedTemporaryFile(mode='wb', delete=False) as tmp:
                tmp.write(response.read())
                tmp_path = tmp.name
        
        # è¿è¡Œget-pip.py
        subprocess.run([sys.executable, tmp_path, "--user"], check=True)
        os.unlink(tmp_path)
        print("âœ… pipå®‰è£…æˆåŠŸ")
        return True
    except Exception as e:
        print(f"âŒ pipå®‰è£…å¤±è´¥: {e}")
        return False

def install_packages():
    """å®‰è£…æ‰€éœ€çš„åŒ…"""
    packages = [
        "Flask==2.3.3",
        "Flask-Login==0.6.3", 
        "Werkzeug==2.3.7",
        "Markdown==3.5.1",
        "Pygments==2.16.1"
    ]
    
    pip_cmd = [sys.executable, "-m", "pip", "install", "--user"]
    
    for package in packages:
        print(f"ğŸ“¦ æ­£åœ¨å®‰è£… {package}...")
        try:
            subprocess.run(pip_cmd + [package], check=True)
            print(f"âœ… {package} å®‰è£…æˆåŠŸ")
        except subprocess.CalledProcessError as e:
            print(f"âŒ {package} å®‰è£…å¤±è´¥: {e}")
            return False
    
    return True

def main():
    print("ğŸ Pythonä¾èµ–å®‰è£…è„šæœ¬")
    print("=" * 30)
    
    # æ£€æŸ¥pipæ˜¯å¦å­˜åœ¨
    try:
        subprocess.run([sys.executable, "-m", "pip", "--version"], 
                      check=True, capture_output=True)
        print("âœ… pipå·²å­˜åœ¨")
    except subprocess.CalledProcessError:
        print("âš ï¸  pipä¸å­˜åœ¨ï¼Œæ­£åœ¨å®‰è£…...")
        if not install_pip():
            print("âŒ æ— æ³•å®‰è£…pipï¼Œè¯·æ‰‹åŠ¨å®‰è£…")
            return False
    
    # å®‰è£…åŒ…
    print("\nğŸ”§ å¼€å§‹å®‰è£…ä¾èµ–åŒ…...")
    if install_packages():
        print("\nğŸ‰ æ‰€æœ‰ä¾èµ–å®‰è£…å®Œæˆï¼")
        return True
    else:
        print("\nâŒ éƒ¨åˆ†ä¾èµ–å®‰è£…å¤±è´¥")
        return False

if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)