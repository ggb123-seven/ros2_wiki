#!/usr/bin/env python3
"""
ROS2 Wikiç”¨æˆ·æ³¨å†ŒåŠŸèƒ½ç»¼åˆè¯Šæ–­è„šæœ¬
ç³»ç»Ÿæ€§è¯Šæ–­ç”¨æˆ·æ³¨å†ŒåŠŸèƒ½çš„æ‰€æœ‰å¯èƒ½å¤±è´¥ç‚¹
"""

import sys
import os
import traceback
import sqlite3
from datetime import datetime
from werkzeug.security import generate_password_hash

# å¯¼å…¥åº”ç”¨
try:
    from app import app, get_db_connection, HAS_POSTGRESQL
    print("âœ… æˆåŠŸå¯¼å…¥åº”ç”¨æ¨¡å—")
except ImportError as e:
    print(f"âŒ å¯¼å…¥åº”ç”¨æ¨¡å—å¤±è´¥: {e}")
    sys.exit(1)

class UserRegistrationDiagnostic:
    """ç”¨æˆ·æ³¨å†Œè¯Šæ–­ç±»"""
    
    def __init__(self):
        self.test_results = {}
        self.errors = []
        self.warnings = []
        
    def log_result(self, test_name, passed, details="", error=None):
        """è®°å½•æµ‹è¯•ç»“æœ"""
        self.test_results[test_name] = {
            'passed': passed,
            'details': details,
            'error': str(error) if error else None,
            'timestamp': datetime.now()
        }
        
        status = "âœ… é€šè¿‡" if passed else "âŒ å¤±è´¥"
        print(f"{status} {test_name}: {details}")
        
        if not passed and error:
            self.errors.append(f"{test_name}: {error}")
        elif not passed:
            self.warnings.append(f"{test_name}: {details}")
    
    def test_database_connection(self):
        """æµ‹è¯•æ•°æ®åº“è¿æ¥"""
        print("\nğŸ§ª æµ‹è¯•æ•°æ®åº“è¿æ¥...")
        
        try:
            conn = get_db_connection()
            cursor = conn.cursor()
            cursor.execute('SELECT 1')
            result = cursor.fetchone()
            conn.close()
            
            if result and result[0] == 1:
                db_type = "PostgreSQL" if HAS_POSTGRESQL and app.config['DATABASE_URL'] else "SQLite"
                self.log_result("æ•°æ®åº“è¿æ¥", True, f"{db_type}è¿æ¥æ­£å¸¸")
                return True
            else:
                self.log_result("æ•°æ®åº“è¿æ¥", False, "è¿æ¥æµ‹è¯•å¤±è´¥")
                return False
                
        except Exception as e:
            self.log_result("æ•°æ®åº“è¿æ¥", False, "è¿æ¥å¼‚å¸¸", e)
            return False
    
    def test_users_table_structure(self):
        """æµ‹è¯•ç”¨æˆ·è¡¨ç»“æ„"""
        print("\nğŸ§ª æµ‹è¯•ç”¨æˆ·è¡¨ç»“æ„...")
        
        try:
            conn = get_db_connection()
            cursor = conn.cursor()
            
            # æ£€æŸ¥ç”¨æˆ·è¡¨æ˜¯å¦å­˜åœ¨
            if HAS_POSTGRESQL and app.config['DATABASE_URL']:
                cursor.execute("""
                    SELECT column_name, data_type, is_nullable 
                    FROM information_schema.columns 
                    WHERE table_name = 'users'
                    ORDER BY ordinal_position
                """)
            else:
                cursor.execute("PRAGMA table_info(users)")
            
            columns = cursor.fetchall()
            conn.close()
            
            if not columns:
                self.log_result("ç”¨æˆ·è¡¨ç»“æ„", False, "ç”¨æˆ·è¡¨ä¸å­˜åœ¨")
                return False
            
            # æ£€æŸ¥å¿…è¦å­—æ®µ
            required_fields = ['id', 'username', 'email', 'password_hash', 'created_at']
            if HAS_POSTGRESQL and app.config['DATABASE_URL']:
                existing_fields = [col[0] for col in columns]
            else:
                existing_fields = [col[1] for col in columns]
            
            missing_fields = [field for field in required_fields if field not in existing_fields]
            
            if missing_fields:
                self.log_result("ç”¨æˆ·è¡¨ç»“æ„", False, f"ç¼ºå°‘å­—æ®µ: {missing_fields}")
                return False
            else:
                self.log_result("ç”¨æˆ·è¡¨ç»“æ„", True, f"åŒ…å«æ‰€æœ‰å¿…è¦å­—æ®µ: {existing_fields}")
                return True
                
        except Exception as e:
            self.log_result("ç”¨æˆ·è¡¨ç»“æ„", False, "æ£€æŸ¥å¼‚å¸¸", e)
            return False
    
    def test_password_hashing(self):
        """æµ‹è¯•å¯†ç å“ˆå¸ŒåŠŸèƒ½"""
        print("\nğŸ§ª æµ‹è¯•å¯†ç å“ˆå¸ŒåŠŸèƒ½...")
        
        try:
            test_password = "test_password_123"
            
            # æµ‹è¯•å¯†ç å“ˆå¸Œç”Ÿæˆ
            password_hash = generate_password_hash(test_password)
            
            if password_hash and len(password_hash) > 20:
                self.log_result("å¯†ç å“ˆå¸Œç”Ÿæˆ", True, f"å“ˆå¸Œé•¿åº¦: {len(password_hash)}")
            else:
                self.log_result("å¯†ç å“ˆå¸Œç”Ÿæˆ", False, "å“ˆå¸Œç”Ÿæˆå¤±è´¥æˆ–é•¿åº¦å¼‚å¸¸")
                return False
            
            # æµ‹è¯•å¯†ç éªŒè¯
            from werkzeug.security import check_password_hash
            
            if check_password_hash(password_hash, test_password):
                self.log_result("å¯†ç å“ˆå¸ŒéªŒè¯", True, "å¯†ç éªŒè¯æ­£å¸¸")
                return True
            else:
                self.log_result("å¯†ç å“ˆå¸ŒéªŒè¯", False, "å¯†ç éªŒè¯å¤±è´¥")
                return False
                
        except Exception as e:
            self.log_result("å¯†ç å“ˆå¸ŒåŠŸèƒ½", False, "å“ˆå¸ŒåŠŸèƒ½å¼‚å¸¸", e)
            return False
    
    def test_form_data_handling(self):
        """æµ‹è¯•è¡¨å•æ•°æ®å¤„ç†"""
        print("\nğŸ§ª æµ‹è¯•è¡¨å•æ•°æ®å¤„ç†...")
        
        try:
            # æ¨¡æ‹ŸFlaskè¯·æ±‚ä¸Šä¸‹æ–‡
            with app.test_request_context('/register', method='POST', 
                                        data={'username': 'test_user', 
                                              'email': 'test@example.com', 
                                              'password': 'test_password'}):
                from flask import request
                
                # æµ‹è¯•å®‰å…¨çš„è¡¨å•æ•°æ®è·å–
                username = request.form.get('username', '').strip()
                email = request.form.get('email', '').strip()
                password = request.form.get('password', '')
                
                if username and email and password:
                    self.log_result("è¡¨å•æ•°æ®è·å–", True, f"è·å–åˆ°: {username}, {email}")
                else:
                    self.log_result("è¡¨å•æ•°æ®è·å–", False, "è¡¨å•æ•°æ®è·å–å¤±è´¥")
                    return False
                
                # æµ‹è¯•ç›´æ¥è®¿é—®ï¼ˆä¸å®‰å…¨æ–¹å¼ï¼‰
                try:
                    direct_username = request.form['username']
                    self.log_result("ç›´æ¥è¡¨å•è®¿é—®", True, "ç›´æ¥è®¿é—®æˆåŠŸï¼ˆå­˜åœ¨é£é™©ï¼‰")
                except KeyError:
                    self.log_result("ç›´æ¥è¡¨å•è®¿é—®", False, "ç›´æ¥è®¿é—®å¤±è´¥ï¼ˆKeyErroré£é™©ï¼‰")
                
                return True
                
        except Exception as e:
            self.log_result("è¡¨å•æ•°æ®å¤„ç†", False, "å¤„ç†å¼‚å¸¸", e)
            return False
    
    def test_user_creation_simulation(self):
        """æµ‹è¯•ç”¨æˆ·åˆ›å»ºæ¨¡æ‹Ÿï¼ˆä¸å®é™…åˆ›å»ºï¼‰"""
        print("\nğŸ§ª æµ‹è¯•ç”¨æˆ·åˆ›å»ºæ¨¡æ‹Ÿ...")
        
        try:
            # æ£€æŸ¥æ˜¯å¦æœ‰ç°æœ‰çš„UserManager
            try:
                from app_blueprints.permissions import get_user_manager
                um = get_user_manager()
                self.log_result("UserManagerå¯ç”¨æ€§", True, "UserManageræ¨¡å—å¯ç”¨")
                
                # æµ‹è¯•UserManagerçš„create_useræ–¹æ³•æ˜¯å¦å­˜åœ¨
                if hasattr(um, 'create_user'):
                    self.log_result("UserManager.create_user", True, "create_useræ–¹æ³•å­˜åœ¨")
                else:
                    self.log_result("UserManager.create_user", False, "create_useræ–¹æ³•ä¸å­˜åœ¨")
                    
            except ImportError as e:
                self.log_result("UserManagerå¯ç”¨æ€§", False, "UserManageræ¨¡å—ä¸å¯ç”¨", e)
            
            # æµ‹è¯•æ•°æ®åº“æ’å…¥è¯­å¥è¯­æ³•
            conn = get_db_connection()
            cursor = conn.cursor()
            use_postgresql = app.config['DATABASE_URL'] and HAS_POSTGRESQL
            
            # æµ‹è¯•æŸ¥è¯¢è¯­æ³•
            if use_postgresql:
                test_query = 'SELECT * FROM users WHERE username = %s OR email = %s'
                placeholder = '%s'
            else:
                test_query = 'SELECT * FROM users WHERE username = ? OR email = ?'
                placeholder = '?'
            
            self.log_result("SQLè¯­æ³•æ£€æŸ¥", True, f"å ä½ç¬¦: {placeholder}")
            
            # æµ‹è¯•æ’å…¥è¯­å¥è¯­æ³•ï¼ˆä¸å®é™…æ‰§è¡Œï¼‰
            if use_postgresql:
                insert_query = 'INSERT INTO users (username, email, password_hash) VALUES (%s, %s, %s)'
            else:
                insert_query = 'INSERT INTO users (username, email, password_hash) VALUES (?, ?, ?)'
            
            self.log_result("æ’å…¥è¯­å¥è¯­æ³•", True, "SQLè¯­å¥æ ¼å¼æ­£ç¡®")
            
            conn.close()
            return True
            
        except Exception as e:
            self.log_result("ç”¨æˆ·åˆ›å»ºæ¨¡æ‹Ÿ", False, "æ¨¡æ‹Ÿå¼‚å¸¸", e)
            return False
    
    def test_error_handling_infrastructure(self):
        """æµ‹è¯•é”™è¯¯å¤„ç†åŸºç¡€è®¾æ–½"""
        print("\nğŸ§ª æµ‹è¯•é”™è¯¯å¤„ç†åŸºç¡€è®¾æ–½...")
        
        try:
            # æ£€æŸ¥é”™è¯¯å¤„ç†è“å›¾æ˜¯å¦å­˜åœ¨
            try:
                from app_blueprints.errors import errors_bp
                self.log_result("é”™è¯¯å¤„ç†è“å›¾", True, "errors_bpè“å›¾å­˜åœ¨")
            except ImportError as e:
                self.log_result("é”™è¯¯å¤„ç†è“å›¾", False, "errors_bpè“å›¾ä¸å­˜åœ¨", e)
                return False
            
            # æ£€æŸ¥æ˜¯å¦å·²æ³¨å†Œåˆ°ä¸»åº”ç”¨
            blueprint_names = [bp.name for bp in app.blueprints.values()]
            if 'errors' in blueprint_names:
                self.log_result("é”™è¯¯å¤„ç†æ³¨å†Œ", True, "errorsè“å›¾å·²æ³¨å†Œ")
            else:
                self.log_result("é”™è¯¯å¤„ç†æ³¨å†Œ", False, "errorsè“å›¾æœªæ³¨å†Œåˆ°ä¸»åº”ç”¨")
            
            # æ£€æŸ¥Flask-Loginæ˜¯å¦æ­£å¸¸
            try:
                from flask_login import current_user
                self.log_result("Flask-Login", True, "Flask-Loginæ¨¡å—æ­£å¸¸")
            except ImportError as e:
                self.log_result("Flask-Login", False, "Flask-Loginæ¨¡å—å¼‚å¸¸", e)
            
            return True
            
        except Exception as e:
            self.log_result("é”™è¯¯å¤„ç†åŸºç¡€è®¾æ–½", False, "æ£€æŸ¥å¼‚å¸¸", e)
            return False
    
    def test_register_route_analysis(self):
        """åˆ†æå½“å‰registerè·¯ç”±çš„é—®é¢˜"""
        print("\nğŸ§ª åˆ†æå½“å‰registerè·¯ç”±...")
        
        try:
            # æ£€æŸ¥registerè·¯ç”±æ˜¯å¦å­˜åœ¨
            with app.test_client() as client:
                response = client.get('/register')
                if response.status_code == 200:
                    self.log_result("registerè·¯ç”±å¯è®¿é—®", True, f"çŠ¶æ€ç : {response.status_code}")
                else:
                    self.log_result("registerè·¯ç”±å¯è®¿é—®", False, f"çŠ¶æ€ç : {response.status_code}")
            
            # æ¨¡æ‹ŸPOSTè¯·æ±‚æµ‹è¯•ï¼ˆä½¿ç”¨æ— æ•ˆæ•°æ®ï¼‰
            with app.test_client() as client:
                try:
                    response = client.post('/register', data={})
                    self.log_result("ç©ºè¡¨å•POSTæµ‹è¯•", True, f"çŠ¶æ€ç : {response.status_code}")
                except Exception as e:
                    self.log_result("ç©ºè¡¨å•POSTæµ‹è¯•", False, "POSTè¯·æ±‚å¼‚å¸¸", e)
            
            return True
            
        except Exception as e:
            self.log_result("registerè·¯ç”±åˆ†æ", False, "åˆ†æå¼‚å¸¸", e)
            return False
    
    def run_comprehensive_diagnostic(self):
        """è¿è¡Œç»¼åˆè¯Šæ–­"""
        print("=" * 60)
        print("ğŸš€ ROS2 Wikiç”¨æˆ·æ³¨å†ŒåŠŸèƒ½ç»¼åˆè¯Šæ–­")
        print("=" * 60)
        
        # è¿è¡Œæ‰€æœ‰æµ‹è¯•
        tests = [
            self.test_database_connection,
            self.test_users_table_structure,
            self.test_password_hashing,
            self.test_form_data_handling,
            self.test_user_creation_simulation,
            self.test_error_handling_infrastructure,
            self.test_register_route_analysis
        ]
        
        passed_tests = 0
        total_tests = len(tests)
        
        for test in tests:
            try:
                if test():
                    passed_tests += 1
            except Exception as e:
                print(f"ğŸ’¥ æµ‹è¯• {test.__name__} å‘ç”Ÿå¼‚å¸¸: {e}")
                traceback.print_exc()
        
        # ç”Ÿæˆè¯Šæ–­æŠ¥å‘Š
        self.generate_diagnostic_report(passed_tests, total_tests)
        
        return passed_tests == total_tests
    
    def generate_diagnostic_report(self, passed_tests, total_tests):
        """ç”Ÿæˆè¯Šæ–­æŠ¥å‘Š"""
        print(f"\nğŸ“Š è¯Šæ–­ç»“æœæ±‡æ€»:")
        print(f"   é€šè¿‡æµ‹è¯•: {passed_tests}/{total_tests}")
        print(f"   æˆåŠŸç‡: {passed_tests/total_tests*100:.1f}%")
        
        if self.errors:
            print(f"\nâŒ å‘ç°çš„é”™è¯¯ ({len(self.errors)}ä¸ª):")
            for error in self.errors:
                print(f"   â€¢ {error}")
        
        if self.warnings:
            print(f"\nâš ï¸ è­¦å‘Šä¿¡æ¯ ({len(self.warnings)}ä¸ª):")
            for warning in self.warnings:
                print(f"   â€¢ {warning}")
        
        # ç”Ÿæˆä¿®å¤å»ºè®®
        print(f"\nğŸ”§ ä¿®å¤å»ºè®®:")
        
        if any("é”™è¯¯å¤„ç†æ³¨å†Œ" in result and not result['passed'] for result in self.test_results.values()):
            print("   1. æ³¨å†Œerrors_bpè“å›¾åˆ°ä¸»åº”ç”¨")
        
        if any("UserManager" in result and not result['passed'] for result in self.test_results.values()):
            print("   2. ä½¿ç”¨ç°æœ‰UserManager.create_user()æ–¹æ³•")
        
        if any("è¡¨å•æ•°æ®" in result and not result['passed'] for result in self.test_results.values()):
            print("   3. ä½¿ç”¨request.form.get()å®‰å…¨è·å–è¡¨å•æ•°æ®")
        
        print("   4. åœ¨registerè·¯ç”±ä¸­æ·»åŠ å®Œæ•´çš„å¼‚å¸¸å¤„ç†")
        print("   5. é›†æˆç°æœ‰çš„å®‰å…¨éªŒè¯æœºåˆ¶")

def main():
    """ä¸»å‡½æ•°"""
    try:
        diagnostic = UserRegistrationDiagnostic()
        success = diagnostic.run_comprehensive_diagnostic()
        
        if success:
            print("\nğŸ‰ è¯Šæ–­å®Œæˆï¼æ‰€æœ‰æµ‹è¯•é€šè¿‡ã€‚")
        else:
            print("\nâš ï¸ è¯Šæ–­å®Œæˆï¼Œå‘ç°é—®é¢˜éœ€è¦ä¿®å¤ã€‚")
        
        return success
        
    except Exception as e:
        print(f"\nğŸ’¥ è¯Šæ–­è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸: {e}")
        traceback.print_exc()
        return False

if __name__ == '__main__':
    success = main()
    sys.exit(0 if success else 1)
