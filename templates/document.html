{% extends "base.html" %}

{% block title %}{{ document[1] }} - ROS2 Wiki{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}">首页</a></li>
                <li class="breadcrumb-item active">{{ document[1] }}</li>
            </ol>
        </nav>
        
        <article class="card">
            <div class="card-header">
                <h1>{{ document[1] }}</h1>
                <small class="text-muted">
                    分类：{{ document[4] }} | 
                    作者：{{ document[7] or '管理员' }} | 
                    发布时间：{{ document[5][:16] }}
                </small>
            </div>
            <div class="card-body">
                <div id="document-content">
                    <!-- 文档内容将通过JavaScript加载 -->
                </div>
            </div>
        </article>
        
        <!-- 评论区 -->
        <div class="card mt-4">
            <div class="card-header">
                <h4>评论 ({{ comments|length }})</h4>
            </div>
            <div class="card-body">
                {% if current_user.is_authenticated %}
                <form method="POST" action="{{ url_for('add_comment', doc_id=document[0]) }}" class="mb-4">
                    <div class="mb-3">
                        <label for="content" class="form-label">添加评论</label>
                        <textarea class="form-control" id="content" name="content" rows="3" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">发表评论</button>
                </form>
                {% else %}
                <p class="alert alert-info">请<a href="{{ url_for('login') }}">登录</a>后发表评论</p>
                {% endif %}
                
                {% for comment in comments %}
                <div class="border-bottom pb-3 mb-3">
                    <div class="d-flex justify-content-between">
                        <strong>{{ comment[4] }}</strong>
                        <small class="text-muted">{{ comment[3][:16] }}</small>
                    </div>
                    <p class="mt-2">{{ comment[2] }}</p>
                </div>
                {% endfor %}
                
                {% if not comments %}
                <p class="text-muted">暂无评论，快来发表第一条评论吧！</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5>本页导航</h5>
            </div>
            <div class="card-body">
                <div id="toc">
                    <!-- 目录将通过JavaScript生成 -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// 加载文档内容
fetch('/api/documents/{{ document[0] }}/render-html')
    .then(response => response.json())
    .then(data => {
        document.getElementById('document-content').innerHTML = data.html_content;
        
        // 重新高亮代码
        hljs.highlightAll();
        
        // 生成目录
        generateTOC();
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('document-content').innerHTML = '<p class="text-danger">加载失败，请刷新页面重试。</p>';
    });

// 生成目录
function generateTOC() {
    const headers = document.querySelectorAll('#document-content h1, #document-content h2, #document-content h3');
    const toc = document.getElementById('toc');
    
    if (headers.length === 0) {
        toc.innerHTML = '<p class="text-muted">无标题</p>';
        return;
    }
    
    let tocHTML = '<ul class="list-unstyled">';
    headers.forEach((header, index) => {
        const id = 'heading-' + index;
        header.id = id;
        const level = header.tagName.substr(1);
        const indent = (level - 1) * 20;
        tocHTML += `<li style="margin-left: ${indent}px;"><a href="#${id}" class="text-decoration-none">${header.textContent}</a></li>`;
    });
    tocHTML += '</ul>';
    toc.innerHTML = tocHTML;
}
</script>
{% endblock %}