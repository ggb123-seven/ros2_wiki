{% extends "base.html" %}

{% block title %}æœç´¢ç»“æœ{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- æœç´¢æ¡† -->
    <div class="row mb-4">
        <div class="col-12">
            <form method="GET" action="{{ url_for('search.search_page') }}" class="d-flex">
                <input type="text" 
                       name="q" 
                       value="{{ query }}" 
                       class="form-control me-2" 
                       placeholder="æœç´¢æ•™ç¨‹ã€åˆ†ç±»æˆ–å†…å®¹..."
                       autocomplete="off"
                       id="searchInput">
                <button type="submit" class="btn btn-primary">æœç´¢</button>
            </form>
        </div>
    </div>

    {% if query %}
    <!-- æœç´¢ç»“æœç»Ÿè®¡ -->
    <div class="row mb-3">
        <div class="col-12">
            <p class="text-muted">
                æ‰¾åˆ° <strong>{{ total }}</strong> ä¸ªå…³äº "<strong>{{ query }}</strong>" çš„ç»“æœ
                {% if total > 0 %}
                (ç¬¬ {{ (page-1) * per_page + 1 }} - {{ min(page * per_page, total) }} ä¸ª)
                {% endif %}
            </p>
        </div>
    </div>

    <!-- æœç´¢ç»“æœ -->
    {% if results %}
    <div class="row">
        <div class="col-12">
            {% for result in results %}
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">
                        <a href="{{ url_for('main.document', id=result.id) }}" class="text-decoration-none">
                            {{ result.title|safe }}
                        </a>
                    </h5>
                    <h6 class="card-subtitle mb-2 text-muted">
                        <span class="badge bg-secondary">{{ result.category }}</span>
                        <small class="ms-2">{{ result.created_at }}</small>
                        {% if result.relevance_score %}
                        <span class="badge bg-info ms-2">ç›¸å…³åº¦: {{ result.relevance_score }}</span>
                        {% endif %}
                    </h6>
                    <p class="card-text">{{ result.snippet|safe }}</p>
                    <a href="{{ url_for('main.document', id=result.id) }}" class="btn btn-sm btn-outline-primary">
                        æŸ¥çœ‹è¯¦æƒ…
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- åˆ†é¡µå¯¼èˆª -->
    {% if total > per_page %}
    <nav aria-label="æœç´¢ç»“æœåˆ†é¡µ">
        <ul class="pagination justify-content-center">
            {% set total_pages = (total + per_page - 1) // per_page %}
            
            <!-- ä¸Šä¸€é¡µ -->
            {% if page > 1 %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('search.search_page', q=query, page=page-1, per_page=per_page) }}">
                    ä¸Šä¸€é¡µ
                </a>
            </li>
            {% endif %}
            
            <!-- é¡µç  -->
            {% for p in range(max(1, page-2), min(total_pages+1, page+3)) %}
            <li class="page-item {% if p == page %}active{% endif %}">
                <a class="page-link" href="{{ url_for('search.search_page', q=query, page=p, per_page=per_page) }}">
                    {{ p }}
                </a>
            </li>
            {% endfor %}
            
            <!-- ä¸‹ä¸€é¡µ -->
            {% if page < total_pages %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('search.search_page', q=query, page=page+1, per_page=per_page) }}">
                    ä¸‹ä¸€é¡µ
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}

    {% else %}
    <!-- æ— ç»“æœ -->
    <div class="row">
        <div class="col-12">
            <div class="alert alert-info">
                <h4 class="alert-heading">æœªæ‰¾åˆ°ç›¸å…³ç»“æœ</h4>
                <p>æŠ±æ­‰ï¼Œæ²¡æœ‰æ‰¾åˆ°ä¸ "<strong>{{ query }}</strong>" ç›¸å…³çš„å†…å®¹ã€‚</p>
                <hr>
                <p class="mb-0">å»ºè®®ï¼š</p>
                <ul class="mb-0">
                    <li>æ£€æŸ¥å…³é”®è¯æ‹¼å†™æ˜¯å¦æ­£ç¡®</li>
                    <li>å°è¯•ä½¿ç”¨æ›´ç®€çŸ­çš„å…³é”®è¯</li>
                    <li>ä½¿ç”¨åŒä¹‰è¯æˆ–ç›¸å…³è¯æ±‡</li>
                </ul>
            </div>
        </div>
    </div>
    {% endif %}

    {% else %}
    <!-- æœç´¢å»ºè®®å’Œçƒ­é—¨æœç´¢ -->
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ğŸ”¥ çƒ­é—¨æœç´¢</h5>
                </div>
                <div class="card-body">
                    <div id="popularSearches">
                        <div class="text-center">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">åŠ è½½ä¸­...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ğŸ’¡ æœç´¢æç¤º</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li><strong>ç²¾ç¡®åŒ¹é…:</strong> ä½¿ç”¨å¼•å· "ROS2 å¯¼èˆª"</li>
                        <li><strong>å¤šå…³é”®è¯:</strong> æœºå™¨äºº ä¼ æ„Ÿå™¨ å®šä½</li>
                        <li><strong>åˆ†ç±»æœç´¢:</strong> æœç´¢ç‰¹å®šåˆ†ç±»åç§°</li>
                        <li><strong>å†…å®¹æœç´¢:</strong> æœç´¢æ•™ç¨‹å†…å®¹ä¸­çš„å…³é”®è¯</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- æœç´¢å»ºè®®ä¸‹æ‹‰æ¡† -->
<div id="searchSuggestions" class="dropdown-menu" style="display: none; position: absolute; z-index: 1000;">
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const suggestionsContainer = document.getElementById('searchSuggestions');
    let suggestionTimeout;

    // æœç´¢å»ºè®®åŠŸèƒ½
    searchInput.addEventListener('input', function() {
        const query = this.value.trim();
        
        clearTimeout(suggestionTimeout);
        
        if (query.length < 2) {
            suggestionsContainer.style.display = 'none';
            return;
        }
        
        suggestionTimeout = setTimeout(() => {
            fetch(`{{ url_for('search.search_suggestions') }}?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    showSuggestions(data.suggestions);
                })
                .catch(error => {
                    console.error('è·å–æœç´¢å»ºè®®å¤±è´¥:', error);
                });
        }, 300);
    });

    // æ˜¾ç¤ºæœç´¢å»ºè®®
    function showSuggestions(suggestions) {
        suggestionsContainer.innerHTML = '';
        
        if (suggestions.length === 0) {
            suggestionsContainer.style.display = 'none';
            return;
        }
        
        suggestions.forEach(suggestion => {
            const item = document.createElement('a');
            item.className = 'dropdown-item';
            item.href = '#';
            item.innerHTML = `<span class="badge bg-secondary me-2">${suggestion.type}</span>${suggestion.text}`;
            
            item.addEventListener('click', function(e) {
                e.preventDefault();
                searchInput.value = suggestion.text;
                suggestionsContainer.style.display = 'none';
                searchInput.form.submit();
            });
            
            suggestionsContainer.appendChild(item);
        });
        
        // å®šä½å»ºè®®æ¡†
        const rect = searchInput.getBoundingClientRect();
        suggestionsContainer.style.top = (rect.bottom + window.scrollY) + 'px';
        suggestionsContainer.style.left = rect.left + 'px';
        suggestionsContainer.style.width = rect.width + 'px';
        suggestionsContainer.style.display = 'block';
    }

    // ç‚¹å‡»å…¶ä»–åœ°æ–¹éšè—å»ºè®®
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
            suggestionsContainer.style.display = 'none';
        }
    });

    // åŠ è½½çƒ­é—¨æœç´¢ï¼ˆä»…åœ¨é¦–é¡µæ˜¾ç¤ºï¼‰
    {% if not query %}
    loadPopularSearches();
    {% endif %}

    function loadPopularSearches() {
        fetch('{{ url_for("search.popular_searches") }}')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('popularSearches');
                if (data.popular_searches && data.popular_searches.length > 0) {
                    container.innerHTML = data.popular_searches.map(term => 
                        `<a href="{{ url_for('search.search_page') }}?q=${encodeURIComponent(term)}" 
                           class="badge bg-light text-dark me-2 mb-2 text-decoration-none">${term}</a>`
                    ).join('');
                } else {
                    container.innerHTML = '<p class="text-muted mb-0">æš‚æ— çƒ­é—¨æœç´¢</p>';
                }
            })
            .catch(error => {
                console.error('åŠ è½½çƒ­é—¨æœç´¢å¤±è´¥:', error);
                document.getElementById('popularSearches').innerHTML = 
                    '<p class="text-muted mb-0">åŠ è½½å¤±è´¥</p>';
            });
    }
});
</script>

<style>
/* æœç´¢é«˜äº®æ ·å¼ */
.search-highlight {
    background-color: #fff3cd;
    padding: 1px 2px;
    border-radius: 2px;
}

/* æœç´¢å»ºè®®æ ·å¼ */
#searchSuggestions {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    background-color: white;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

#searchSuggestions .dropdown-item:hover {
    background-color: #f8f9fa;
}
</style>
{% endblock %}